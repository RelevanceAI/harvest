# Block 1.1: Modal Sandbox Infrastructure - Implementation Plan
**Date**: 2026-01-14  
**Phase**: 1 (Foundation)  
**Block**: 1.1  
**Status**: IN PROGRESS  

---

## Overview

Build core execution environment for Harvest AI agent: Modal Sandbox infrastructure with image management, persistent state, and automated refresh.

**Goal**: Enable Harvest to execute arbitrary AI-generated code in isolated, sandboxed environments.

**Success Criteria**:
- Sandboxes spin up in <5 seconds
- Code executes with full stdout/stderr capture
- Shared state persists across executions via Volumes
- Environment refresh runs automatically every 30 minutes
- Test harness verifies sandbox creation and code execution

---

## Architecture Overview

```
┌─────────────────────────────────────────────┐
│        Modal App (Harvest Agent Executor)   │
├─────────────────────────────────────────────┤
│                                             │
│  Base Image (debian_slim + deps)            │
│  └─ Scheduled Refresh (every 30 min)        │
│                                             │
│  Sandboxes (ephemeral, on-demand)           │
│  ├─ Sandbox 1: Agent Code Execution        │
│  ├─ Sandbox 2: Agent Code Execution        │
│  └─ Snapshot Store: Pre-initialized State  │
│                                             │
│  Shared Volume (/mnt/state)                 │
│  ├─ Cached dependencies                    │
│  ├─ Downloaded models                      │
│  └─ Workspace git repos                    │
│                                             │
└─────────────────────────────────────────────┘
```

---

## Deliverables & Tasks

### Task 1.1.1: Project Scaffolding & Modal Setup
**Effort**: 30-45 min (AI) | External: Modal CLI setup  
**Files Created**:
- `packages/modal-executor/` - New Python package for Modal integration
- `packages/modal-executor/pyproject.toml` - Package definition
- `packages/modal-executor/src/modal_executor/` - Main module
- `packages/modal-executor/src/modal_executor/__init__.py`
- `packages/modal-executor/src/modal_executor/app.py` - Modal app definition
- `packages/modal-executor/src/modal_executor/sandbox.py` - Sandbox wrapper
- `packages/modal-executor/src/modal_executor/volume.py` - Volume management
- `packages/modal-executor/.env.example` - Example env vars
- `docs/setup/modal-setup.md` - Setup instructions

**Deliverables**:
- ✅ Python package structure following Harvest conventions
- ✅ Modal project initialized and deployable
- ✅ Local development setup documented
- ✅ Authentication token handling (MODAL_TOKEN_ID, MODAL_TOKEN_SECRET)

**Key Code**:
```python
# packages/modal-executor/src/modal_executor/app.py
import modal

# Initialize Modal app
app = modal.App("harvest-agent-executor")

# Modal will be configured here in next tasks
```

**Success Criteria**:
- `modal list` shows app in workspace
- Package can be imported: `from modal_executor import app`

---

### Task 1.1.2: Base Image Builder
**Effort**: 30-45 min (AI) | External: ~2-5 min Modal image builds  
**Files Created**:
- `packages/modal-executor/src/modal_executor/images.py` - Image definitions
- `docs/modal/base-image-spec.md` - Image configuration reference

**Deliverables**:
- ✅ Base image with Python 3.11, system tools, and common dependencies
- ✅ Image update mechanism (force rebuild capability)
- ✅ Documented dependency management strategy

**Base Image Configuration** (Target):
```python
# Python 3.11 on Debian Slim
base_image = (
    modal.Image.debian_slim(python_version="3.11")
    .apt_install(
        "git",           # Version control
        "curl",          # HTTP requests
        "build-essential", # C/C++ compilation
        "libffi-dev",    # Foreign function interface
        "libssl-dev",    # SSL/TLS
        "zlib1g-dev",    # Compression
    )
    .pip_install("uv")   # Fast Python package installer
    # Additional common packages TBD in implementation
)
```

**Optimization**:
- Layer caching: Put frequently-changing content (custom deps) last
- Size target: <500MB total (Debian slim starts at ~150MB)

**Success Criteria**:
- Image builds successfully in <30 seconds
- Image size <800MB
- All required tools present (git, curl, build tools)

---

### Task 1.1.3: Persistent State Management (Volumes)
**Effort**: 15-30 min (AI)  
**Files Created**:
- `packages/modal-executor/src/modal_executor/volume.py` - Volume wrapper

**Deliverables**:
- ✅ Shared Volume initialization with standard directory structure
- ✅ Volume mounting in Sandbox instances
- ✅ Commit strategy for persistence

**Volume Structure** (Target):
```
/mnt/state/
├── .cache/           # pip cache, downloaded models
├── git-repos/        # Cloned repository copies
├── checkpoints/      # Agent execution snapshots
└── workspace/        # Shared workspace (empty initially)
```

**Key Implementation**:
```python
# packages/modal-executor/src/modal_executor/volume.py
import modal

def get_state_volume():
    """Get or create the shared state volume"""
    return modal.Volume.from_name("harvest-agent-state", create_if_missing=True)

# Volume attached to all Sandboxes:
# volumes={"/mnt/state": get_state_volume()}
```

**Success Criteria**:
- Volume persists across Sandbox terminations
- Directory structure exists and is writable
- `ls /mnt/state/` returns expected directories

---

### Task 1.1.4: Sandbox Wrapper & Execution
**Effort**: 45-90 min (AI) | External: ~5 min Sandbox testing  
**Files Created**:
- `packages/modal-executor/src/modal_executor/sandbox.py` - Sandbox creation/execution wrapper
- `packages/modal-executor/src/modal_executor/types.py` - Type definitions (ExecutionResult)

**Deliverables**:
- ✅ Sandbox creation from base image
- ✅ Code execution with stdout/stderr capture
- ✅ Timeout and error handling
- ✅ Clean termination

**API Design**:
```python
# packages/modal-executor/src/modal_executor/sandbox.py

class ExecutionResult:
    """Result from Sandbox code execution"""
    returncode: int
    stdout: str
    stderr: str
    duration_secs: float
    sandbox_id: str

class SandboxExecutor:
    """Wrapper for Modal Sandbox execution"""
    
    async def execute(
        self,
        code: str,
        timeout_secs: int = 1800,
        # environment variables?
        # working directory?
    ) -> ExecutionResult:
        """Execute code in isolated Sandbox"""
        # Create Sandbox from base_image
        # Mount /mnt/state volume
        # Write code to file or stdin
        # Execute with timeout
        # Capture stdout/stderr
        # Return result
        # Clean up Sandbox
        pass
```

**Success Criteria**:
- Sandbox creates in <5 seconds
- Code output captured and returned
- Timeout enforced (kills process if exceeded)
- Exceptions handled gracefully (return ExecutionResult with error details)

---

### Task 1.1.5: Scheduled Environment Refresh
**Effort**: 15-30 min (AI)  
**Files Created**:
- `packages/modal-executor/src/modal_executor/scheduler.py` - Refresh job definition

**Deliverables**:
- ✅ Cron job that runs every 30 minutes
- ✅ Rebuilds base image with `force_build=True`
- ✅ Clears stale caches in Volume (optional)
- ✅ Retry logic on failures

**Implementation**:
```python
# packages/modal-executor/src/modal_executor/scheduler.py

@app.function(
    schedule=modal.Cron("*/30 * * * *"),  # Every 30 min
    retries=3,  # Retry up to 3 times
    timeout=600,  # 10 min max per run
)
def refresh_environment():
    """Periodic refresh of agent execution environment"""
    
    # 1. Force rebuild base image
    # 2. Verify image building succeeded
    # 3. Optional: Clear stale cache in /mnt/state/.cache/
    # 4. Verify environment is ready
    
    return {
        "status": "success",
        "timestamp": datetime.now(),
        "image_rebuilt": True,
    }
```

**Success Criteria**:
- Job runs every 30 minutes (deploy to production to verify)
- Image rebuilt successfully
- No failures in retry logs
- Job completes in <10 minutes

---

### Task 1.1.6: Test Harness
**Effort**: 30-60 min (AI) | External: ~5 min integration test runs  
**Files Created**:
- `packages/modal-executor/tests/` - Test suite
- `packages/modal-executor/tests/test_sandbox.py` - Sandbox execution tests
- `packages/modal-executor/tests/test_images.py` - Image building tests
- `packages/modal-executor/tests/conftest.py` - Test fixtures
- `docs/modal/testing.md` - Testing guide

**Test Coverage**:
```python
# packages/modal-executor/tests/test_sandbox.py

class TestSandboxCreation:
    @pytest.mark.modal
    async def test_sandbox_creates_under_5_seconds(executor):
        """Verify cold-start time <5s"""
        pass
    
    @pytest.mark.modal
    async def test_code_execution_captures_stdout(executor):
        """Verify stdout/stderr captured correctly"""
        code = 'print("Hello from sandbox")'
        result = await executor.execute(code)
        assert result.stdout == "Hello from sandbox\n"
        assert result.returncode == 0
    
    @pytest.mark.modal
    async def test_timeout_enforced(executor):
        """Verify timeout kills long-running code"""
        code = 'import time; time.sleep(10)'
        result = await executor.execute(code, timeout_secs=2)
        assert result.returncode != 0  # Killed
    
    @pytest.mark.modal
    async def test_volume_mounted_and_writable(executor):
        """Verify /mnt/state volume is accessible"""
        code = 'with open("/mnt/state/test.txt", "w") as f: f.write("test")'
        result = await executor.execute(code)
        assert result.returncode == 0
    
    @pytest.mark.modal
    async def test_sandbox_cleanup_on_error(executor):
        """Verify Sandboxes terminate cleanly"""
        pass

class TestImageBuilding:
    @pytest.mark.modal
    def test_base_image_builds(app):
        """Verify base image builds successfully"""
        pass
    
    @pytest.mark.modal
    def test_image_size_acceptable(app):
        """Verify image <800MB"""
        pass

class TestScheduledRefresh:
    @pytest.mark.modal
    def test_refresh_job_defined(app):
        """Verify cron job is configured"""
        pass
```

**Running Tests**:
- Local: `pytest packages/modal-executor/tests/` (mocked Modal)
- Integration: `pytest packages/modal-executor/tests/ -m modal` (requires Modal credentials)

**Success Criteria**:
- All tests pass
- Sandbox cold-start <5 seconds (verified via integration tests)
- Code execution captures output correctly
- Timeouts enforced
- Volume accessible

---

## Implementation Dependencies

### External Dependencies
- `modal>=0.68.0` - Modal SDK
- `pytest>=7.0` - Testing
- `pytest-asyncio` - Async test support
- `pydantic>=2.0` - Type validation (for ExecutionResult)

### Internal Dependencies
- None for Block 1.1 (standalone)
- Later: Will integrate with Block 1.2 (GitHub App) and Block 1.3 (OpenCode)

### Infrastructure Prerequisites
- Modal workspace created (free tier OK)
- Modal API credentials configured
- Terraform/infrastructure (if IaC planned) - defer to Phase 2

---

## Assumptions & Constraints

### Assumptions
1. Modal's Sandbox API remains stable (v0.68+)
2. 24-hour Sandbox lifetime is acceptable (no single execution >24h)
3. Volumes v1 (max 500K inodes) sufficient for initial use
4. Network connectivity to Modal API available during execution
5. Single region (Modal default) is acceptable

### Constraints
1. **Max execution time**: 24 hours (Sandbox lifetime limit)
2. **Max file count**: 500K inodes in shared Volume
3. **Concurrent Sandboxes**: Limited by plan concurrency (Starter: 10, Team: 50)
4. **Scheduled refresh**: Requires deployed app (not local development)
5. **Cost**: ~$0.0008 per 30-second execution (acceptable at scale)

### Trade-offs
1. **Sandboxes vs Functions**: Chose Sandboxes for arbitrary code execution flexibility
2. **Modal vs self-hosted**: Chose Modal for simplicity, cost, and managed scaling
3. **Volumes v1 vs v2**: Start with v1, upgrade to v2 if file limits hit

---

## Rollout & Deployment Strategy

### Phase 1: Local Development
1. Set up local Modal CLI (`modal setup`)
2. Deploy app locally with `modal run`
3. Run test suite with mock Modal

### Phase 2: Staging Deployment
1. Deploy app: `modal deploy` (creates persistent app)
2. Run integration tests (full Modal execution)
3. Verify cron job scheduling
4. Monitor costs for 24 hours

### Phase 3: Production
1. Deployment handled by Terraform/IaC (Phase 2)
2. Cron jobs active
3. Monitor logs and error rates
4. Set up alerts

**Rollback Plan**:
- If critical issues: Disable cron job (`modal app disable`)
- Revert code changes
- Redeploy

---

## Success Criteria & Testing

### Unit Tests
- ✅ Image definitions parse without errors
- ✅ ExecutionResult types validate
- ✅ Sandbox wrapper handles exceptions

### Integration Tests
- ✅ Sandbox creates in <5 seconds
- ✅ Simple Python code executes successfully
- ✅ stdout/stderr captured correctly
- ✅ Timeout enforced on long-running code
- ✅ Exit codes propagated (0 for success, non-zero for failure)
- ✅ Volume mounted and writable
- ✅ Cron job defined and deployable

### Manual Verification
- ✅ Run code manually: `python -c "from modal_executor import SandboxExecutor; ..."`
- ✅ Check Modal dashboard: App deployed, cron job visible
- ✅ Monitor logs for 24+ hours in staging

### Success Metric
**Block 1.1 is complete when**:
1. All tests pass
2. Sandbox executes code in <5s (cold start)
3. Cron job scheduled and operational
4. Volume persists state across executions
5. Documentation complete and accurate

---

## Post-Implementation (Block 1.2 & 1.3)

### Integration Points
- **Block 1.2 (GitHub App)**: Will use SandboxExecutor to run code during PR reviews
- **Block 1.3 (OpenCode)**: Will run inside Sandbox with `/mnt/state` Volume containing agent rules

### Example Future Usage
```python
# Block 1.3: OpenCode running inside Sandbox
executor = SandboxExecutor()
result = await executor.execute(
    code="""
import modal
# Run OpenCode agent with Harvest rules
os.environ['CLAUDE_API_KEY'] = secrets.get('claude-api-key')
subprocess.run(['opencode', 'execute-task', ...])
    """
)
```

---

## Validation Checklist

Before marking Block 1.1 complete:

- [ ] All 6 tasks implemented and code-reviewed
- [ ] All tests passing (unit + integration)
- [ ] Sandbox cold-start <5 seconds (verified)
- [ ] Code execution works with stdout/stderr capture
- [ ] Volume persists state across runs
- [ ] Cron job scheduled and tested (staging only)
- [ ] Documentation complete (setup, testing, API reference)
- [ ] Dependencies documented (pyproject.toml)
- [ ] No security issues (secrets handling, input validation)
- [ ] Cost reviewed and acceptable
- [ ] PR reviewed and approved
- [ ] Merged to main

---

## Files Summary

### New Files Created
| File | Purpose |
|------|---------|
| `packages/modal-executor/` | New Python package |
| `packages/modal-executor/pyproject.toml` | Package config |
| `packages/modal-executor/src/modal_executor/app.py` | Modal app initialization |
| `packages/modal-executor/src/modal_executor/images.py` | Base image definitions |
| `packages/modal-executor/src/modal_executor/volume.py` | Volume management |
| `packages/modal-executor/src/modal_executor/sandbox.py` | Sandbox executor wrapper |
| `packages/modal-executor/src/modal_executor/types.py` | Type definitions |
| `packages/modal-executor/src/modal_executor/scheduler.py` | Cron refresh job |
| `packages/modal-executor/tests/` | Test suite |
| `docs/setup/modal-setup.md` | Setup instructions |
| `docs/modal/base-image-spec.md` | Image configuration |
| `docs/modal/testing.md` | Testing guide |
| `.env.example` | Example environment variables |

### Modified Files
| File | Change |
|------|--------|
| `pyproject.toml` (root) | Add modal-executor package reference |
| `docs/ARCHITECTURE.md` | Add Block 1.1 diagram and description |

---

## Open Questions / TBD

1. **Environment variables in Sandbox**: How should Sandbox access secrets (API keys, creds)? Via Secrets? Volume? Environment passing?
2. **Working directory**: Should each Sandbox have a separate `/workspace` directory?
3. **Snapshot strategy**: When/how frequently should we snapshot post-initialization state?
4. **Multi-region support**: Do we need multiple Modal regions, or is default sufficient?
5. **Rate limiting**: Any rate limits we should anticipate from Modal API?

---

## References

- [Modal Sandboxes](https://modal.com/docs/guide/sandboxes)
- [Modal Volumes](https://modal.com/docs/guide/volumes)
- [Modal Scheduling](https://modal.com/docs/guide/cron)
- [Modal Pricing](https://modal.com/pricing)

---

**Status**: IMPLEMENTED  
**Next Step**: Integration testing with Modal credentials, then merge
